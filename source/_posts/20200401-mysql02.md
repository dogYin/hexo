---
title: 索引
date: 2020-04-01 13:27:52
tags: mysql
categories: 'mysql'
---
<h1>数据查找</h1>

    在没有索引的情况下查找记录（查询条件为非主键），mysql会从第一个数据页开始遍历，直到找到相应的记录为止，这个过程时间复杂度是o(n),当
    数据量是亿级时，会非常的损耗性能。
    在这里不止是遍历数据页，数据页中还有槽（记录的地址偏移量），因为普通字段没有记录在槽中，所以还要遍历查找，可想而知是有多损耗性能。
    因为innodb会给主键建聚簇索引，所以普通查找的时候遍历的是B+树。

<h1>索引</h1>
  <h2>innodb中的索引方案：</h2> 
  
    我们从第1条记录到第n(+∞)条记录的插入来分析：
        前提：
            1.主键自己生成不采用自增主键
            2.数据储存级别到页，不讨论行级数据储存（可以查看之前博客）
            3.只考虑主键，不考虑其他列索引
            4.分层讲解，层级倒序，第一层代表最底层
        第一层：
            1.当第一条记录进来的时候会分配一个16kb数据页，然后根据主键大小顺序的储存在数据页中。
            2.如何保证数据的顺序性?
                我们先假设有x个页，每个页的记录数为y。
                x个页的数据都是顺序存储的，但是第x*y+1条数据主键值小于第x*y-1条数据；如果忽略顺序存储，则该条数据（x*y+1）应该存储在第x+1页的
                第一条，但是为了保证顺序性会将第x*y+1条数据储存在第x*y-1的位置，x*y-1这条记录会存在x*y的位置，x*y这条记录会存在第x+1页的第一条记录
                这个过程称之为页分裂；在忽略页的情况下这种数据插入可以跟插入排序类比较
        第二层：
            3.索引是什么？
                将底层每个页中的页码和记录的最小主键值抽象为一条记录，类似于我们要储存的记录但是只有两个列，即储存用户记录数据的页码和每页记录最小主键值
                然后再分配一个页将该条记录插进去，所有这种页中记录头字段的record_type均为1，称为索引页。
                但是当数据量比较大的时候，第二层数据页量级也会同比上升，所以这个时候就出现第三层，同样是将第二层索引页的页码和最小值封装成记录然后将记录插
                入分配的数据页中，直到最后只有一个数据页为止。这样就形成了一个B+树
        如何插入：
            前面分析B+树是如何形成的，但是分析思路跟实际操作是相悖的，实际真实数据的插入是从根节点开始的，从第一条记录的诞生开始B+树的根节点就已经确定了，
            根节点刚开始就是普通的数据页，当数据量大于16kb的时候，会再申请一个数据页将根节点中的数据复制到新申请的数据页中，然后根节点存放新数据页的页码和
            最小主键值，当数据量增长的时候，数据页会一直分裂，然后直到存储下所有的数据为止。（数据的插入和页分裂思想可以参考二叉树的生成）
    
    聚簇索引：拥有顺序储存用户完整记录的叶子节点且拥有顺序储存索引记录的非叶子节点的B+树称为聚簇索引，数据初始化的时候引擎会自动给我们创建一个聚簇索引
    
    二级索引：二级索引跟聚簇索引的创建同理，但是二级索引的叶子节点储存的是主键的索引列的值（排序字段是以索引列为主），因为索引列的字段有可能不唯一
             所以，为了方便排序非叶子节点也会储存主键值，索引列值相同的时候就比较主键值得大小
  
  <h2>myisam中的索引方案</h2>
    
     myisam中的索引也是树组成的，但是不同于innodb的是，叶子节点并不储存真实记录而是储存真实记录的主键+行号；
     真实记录储存在数据文件中，该文件中储存记录是一行行的，可以通过行号访问到一条记录且储存的记录并没有按照主键排序。
     
  <h2>Memory引擎的索引</h2>
 
    我们经常会听到hash索引和B+树索引的区别，但是在日常开发中我们经常会使用的是innodb引擎所以基本不怎么接触到hash索引，
    1.只有Memory引擎显示支持哈希索引。
    2.这也是Memory引擎表的默认索引类型，Memory引擎同时也支持B-Tree索引。
    3.Memory引擎是支持非唯一哈希索引的。
    4.如果多个列的哈希值相同，索引会以链表的方式存放多个记录指针到同一个哈希条目中       