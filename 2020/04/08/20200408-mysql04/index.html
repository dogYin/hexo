<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>mysql查询优化 | 寅狗子</title><meta name="keywords" content="mysql"><meta name="author" content="jiabin.wang"><meta name="copyright" content="jiabin.wang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="在索引那节有讲单表查询使用索引的情况，请自行移步 连接查询优化连接分析1select * from table1 t1 xxx join table2 t2 on t1.id &#x3D; t2.t1_id where t1.id&#x3D;1 我们将上述语句中的t1表称为驱动表，t2表称为被驱动表（right join的情况下相反）整个连接过程其实就是，先根据条件查询去驱动表中的记录（扇出值），然后拿着查询出来的记">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql查询优化">
<meta property="og:url" content="http://dogyin.wang/2020/04/08/20200408-mysql04/index.html">
<meta property="og:site_name" content="寅狗子">
<meta property="og:description" content="在索引那节有讲单表查询使用索引的情况，请自行移步 连接查询优化连接分析1select * from table1 t1 xxx join table2 t2 on t1.id &#x3D; t2.t1_id where t1.id&#x3D;1 我们将上述语句中的t1表称为驱动表，t2表称为被驱动表（right join的情况下相反）整个连接过程其实就是，先根据条件查询去驱动表中的记录（扇出值），然后拿着查询出来的记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg">
<meta property="article:published_time" content="2020-04-08T02:31:55.000Z">
<meta property="article:modified_time" content="2021-04-06T07:36:20.782Z">
<meta property="article:author" content="jiabin.wang">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg"><link rel="shortcut icon" href="/img/head.jpg"><link rel="canonical" href="http://dogyin.wang/2020/04/08/20200408-mysql04/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-06 15:36:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/bugs/"><i class="fa-fw fa fa-folder-open"></i><span> bug录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 小狗狗</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">寅狗子</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/bugs/"><i class="fa-fw fa fa-folder-open"></i><span> bug录</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 小狗狗</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mysql查询优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-04-08T02:31:55.000Z" title="发表于 2020-04-08 10:31:55">2020-04-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-06T07:36:20.782Z" title="更新于 2021-04-06 15:36:20">2021-04-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mysql/">mysql</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>在索引那节有讲单表查询使用索引的情况，请自行移步</p>
<h1 id="连接查询优化"><a href="#连接查询优化" class="headerlink" title="连接查询优化"></a>连接查询优化</h1><h2 id="连接分析"><a href="#连接分析" class="headerlink" title="连接分析"></a>连接分析</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table1 t1 xxx <span class="keyword">join</span> table2 t2 <span class="keyword">on</span> t1.id = t2.t1_id <span class="keyword">where</span> t1.id=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>我们将上述语句中的t1表称为驱动表，t2表称为被驱动表（right join的情况下相反）<br>整个连接过程其实就是，先根据条件查询去驱动表中的记录（扇出值），然后拿着查询出来的记录（扇出值）一条条去被驱动表中查询记录，最后组装拼接</p>
<ul>
<li>嵌套循环连接:驱动表只访问一次，但被驱动表却可能被多次访问，访问次数取决于对驱动表执行单表查询后的结果集中的记录条数</li>
<li>eq_ref:如果t1_id列是t2表的主键或者唯一二级索引，单表访问t2表可以达到const级别，在连接查询中我们称之为eq_ref</li>
</ul>
<table>
<thead>
<tr>
<th>连接类型</th>
<th>特点</th>
<th>注意事项</th>
</tr>
</thead>
<tbody><tr>
<td>INNER</td>
<td>内连接，不区分驱动表和被驱动表</td>
<td>在内连接中ON子句和WHERE子句是等价的，只展示按条件过滤的两个表中共有的记录</td>
</tr>
<tr>
<td>LEFT</td>
<td>左外连接，from后面的是驱动表，join后面的是被驱动表</td>
<td>驱动表中不为空，被驱动表为空时，会显示驱动表中记录，被驱动表字段也会显示，但值为null</td>
</tr>
<tr>
<td>RIGHT</td>
<td>右外连接，from后面的是被驱动表，join后面的是驱动表</td>
<td>驱动表中不为空，被驱动表为空时，会显示驱动表中记录，被驱动表字段也会显示，但值为null</td>
</tr>
</tbody></table>
<h2 id="优化1"><a href="#优化1" class="headerlink" title="优化1"></a>优化1</h2><h3 id="使用索引"><a href="#使用索引" class="headerlink" title="使用索引"></a>使用索引</h3><p>通过上面的连接分析，可将连接查询最终拆解为单表查询，这样我们就可以采用单标查询的优化方式（索引）</p>
<h3 id="基于块的嵌套连接"><a href="#基于块的嵌套连接" class="headerlink" title="基于块的嵌套连接"></a>基于块的嵌套连接</h3><ul>
<li>join buffer:执行连接查询前申请的一块固定大小的内存，先把若干条驱动表结果集中的记录装在这个join buffer中，然后开始扫描被驱动表，每一条被驱动表的记录一次性和join buffer中的多条驱动表记录做匹配，因为匹配的过程都是在内存中完成的，所以这样可以显著减少被驱动表的I/O代价</li>
<li>join_buffer_size:该参数可以控制join buffer的大小，默认值为256kb</li>
</ul>
<p><strong>注意：</strong>加入join buffer的列是我们查询中的列，并不是表中所有的列，所以我们查询的时候尽量不要以 select * 查询需要的字段。</p>
<h2 id="优化2（基于成本的优化）"><a href="#优化2（基于成本的优化）" class="headerlink" title="优化2（基于成本的优化）"></a>优化2（基于成本的优化）</h2><p><strong>成本常数：</strong>类似于普朗克常量这种常数系数，一般是根据大量的实验验算出来的，mysql中规定读取一个页的成本默认为1.0，读取或者检测一条记录是否符合搜索条件默认成本为0.2。</p>
<p><strong>单表查询成本：</strong></p>
<ol>
<li>找出所有可使用索引</li>
<li>计算全表扫描代价<br>查询成本 = I/O成本（成本所占用的页面数 ） + CPU成本 （表中的记录数）</li>
<li>计算使用不同索引执行查询的代价</li>
<li>对比各执行方案，选择成本最低<br>成本常数修改，可优化计算成本</li>
</ol>
<h2 id="优化3（基于规则的优化）"><a href="#优化3（基于规则的优化）" class="headerlink" title="优化3（基于规则的优化）"></a>优化3（基于规则的优化）</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> x1,x2 <span class="keyword">where</span> t1 <span class="keyword">in</span> (<span class="keyword">select</span> y1 <span class="keyword">from</span> t2)</span><br></pre></td></tr></table></figure>
<p>上述语句中 t1 为母表  t2 为子表<br><strong>查询重写：</strong>按照引擎的优化规则，重写client发过来的sql</p>
<p>** 优化规则：**</p>
<ol>
<li>移除不必要的括号</li>
<li>常量传递，等值传递（将某处已常量化变量，全部常量化）</li>
<li>移除无用的条件</li>
<li>简单的常量计算，（有复杂表达式的不会优化）</li>
<li>sql中没有聚集函数时，会将having和where子句合并</li>
<li>常量表检测</li>
<li>外连接消除，内连接优化器可以根据成本选择最优的查询方案，所以我们可以采取空值拒绝的方式，外连接隐式的转换为内连接</li>
<li>子查询优化，不相关子查询先查子表再查母表，相关子查询先查母表然后带母表值匹配子表查询条件，然后根据子表结果集过滤数据</li>
<li>in子查询优化：<pre><code>in中匹配的值太多会造成的问题
1.结果集太多，内存空间不够
2.导致全表扫描
解决方案：物化表
将子查询结果集去重后存放在临时表中，当临时表数据少时建立基于内存的myisam哈希索引，数据量大时建立基于磁盘的
B+树索引，这个过程建立的表叫做物化表
将子查询转换为半连接查询：母表不关心和物化表中记录匹配的条数，当前记录是否存在于物化表中
半连接实现：
1.Table pullout （子查询中的表上拉）
2.DuplicateWeedout execution strategy （重复值消除）
3.LooseScan execution strategy （松散扫描）
4.Semi-join Materialization execution strategy
5.FirstMatch execution strategy （首次匹配）
适配条件：
1.在IN关键字条件中，且在外层查询的WHERE或者ON子句中出现，NOT IN关键字不生效
2.外层查询其他的搜索条件和IN子查询的搜索条件必须使用AND连接起来，不能是OR
3.必须是一个单一的查询，不能是由若干查询由UNION连接起来的形式。
4.不能包含GROUP BY或者HAVING语句或者聚集函数。
不适配条件：
产生物化表之后，使用exists查询，因为只需要判断在不在物化表中，不关心条数所以exists即可</code></pre> 常量表：<pre><code>1.查询表中一条没有或者只有一条的记录（依靠MYISAM的引擎统计出来的）
2.使用主键或者唯一二级索引等值匹配</code></pre> 空值拒绝：<pre><code>当where语句条件中，只有驱动表的过滤条件时，查询结果中会出现值为空的被驱动表字段，这时候我们只要在where条件中也添加
被驱动表的过滤条件，可以将外连接隐式的转换成内连接，这样优化引擎可以选择查询成本最低的表为驱动表</code></pre> 子查询：<pre><code>标量子查询：子查询结果集为单一值 但是能是一条记录 select (select x1 from t1 limit 1)
行子查询：子查询结果集有多列值   但只能是一条记录 select (select x1,x2 from t1 limit 1)
列子查询：子查询结果集有一列值   可以是多条记录 select (select x1 from t1)
表子查询：子查询结果集有多列值   可以是多条记录 select (select x1,x2 from t1)
不相关子查询：子查询结果集不依赖外层的值，即子查询的查询条件没有任何母查询表的字段
相关子查询：不相关子查询的反例
注意：
    1.select子句中的查询必须是标量查询
    2.对于[NOT] IN/ANY/SOME/ALL子查询，不能有limit语句
    3.增删改语句不允许出现子查询</code></pre></li>
</ol>
<h2 id="explain关键字详解"><a href="#explain关键字详解" class="headerlink" title="explain关键字详解"></a>explain关键字详解</h2><table>
<thead>
<tr>
<th>列名</th>
<th>描述</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>每个select对应一个唯一id</td>
<td>在连接查询的执行计划中，每个表都会对应一条记录，这些记录的id列的值是相同的，出现在前边的表表示驱动表，出现在后边的表表示被驱动表<br/>对于子查询来说，如果多条记录的id都是一样的则表示优化器将该子查询重写转换成了连接查询</td>
</tr>
<tr>
<td>select_type</td>
<td>查询类型</td>
<td></td>
</tr>
<tr>
<td>table</td>
<td>表名</td>
<td>查询中设计几个表就有几个表名，单表查询统计信息独立成行</td>
</tr>
<tr>
<td>partitions</td>
<td>分区信息</td>
<td>一般情况都为null</td>
</tr>
<tr>
<td>type</td>
<td>针对单表访问的方法</td>
<td>system，const，eq_ref，ref，fulltext，ref_or_null，index_merge，unique_subquery，index_subquery，range，index，ALL</td>
</tr>
<tr>
<td>possible_keys</td>
<td>可能用到的索引</td>
<td>该列值并不是越多越好，可能使用的索引越多，查询优化器计算查询成本时就得花费更长时间，所以如果可以的话，尽量删除那些用不到的索引</td>
</tr>
<tr>
<td>key</td>
<td>实际上使用的索引</td>
<td>实际上使用的索引</td>
</tr>
<tr>
<td>ken_len</td>
<td>实际上使用的索引长度</td>
<td></td>
</tr>
<tr>
<td>ref</td>
<td>当使用索引列等值查询时，与索引列进行等值匹配的对象信息</td>
<td></td>
</tr>
<tr>
<td>rows</td>
<td>预估的需要读取的记录数</td>
<td></td>
</tr>
<tr>
<td>Extra</td>
<td>额外信息</td>
<td></td>
</tr>
</tbody></table>
<p><strong>type:</strong></p>
<ol>
<li>system:单表使用的储存引擎统计数据是精确的，访问方法就是system（Myisam,memory）</li>
<li>const，eq_ref,ref_or_null,index_merge，range，index，ALL等访问方法之前都有讲过</li>
<li>fulltext：全文索引</li>
<li>unique_subquery：优化器将in子查询转换成EXISTS子查询，且在执行子查询时会使用id列索引</li>
<li>index_subquery：同unique_subquery，只不过执行子查询时使用普通二级索引</li>
</ol>
<p><strong>Extra：</strong></p>
<ol>
<li>No tables used: 查询语句中没有from子句</li>
<li>Impossible WHERE： where子句条件失效即为false</li>
<li>No matching min/max row：查询列表处有MIN或者MAX聚集函数，但是并没有符合WHERE子句中的搜索条件的记录</li>
<li>Using index：查询列和搜索条件中只包含属于某个索引的列，即索引覆盖</li>
<li>Using index condition：索引条件下推情况，多个索引其中有些索引无法使用时会根据能使用到的索引先查询记录，然后用使用不到索引的条件过滤一遍再回表</li>
<li>Using where：使用有where条件的全表扫描情况下</li>
<li>Using join buffer (Block Nested Loop)：被驱动表无法有效使用索引时采用join buffer加快检索速度</li>
<li>not exists：外连接查询时，检索被驱动表的条件无效，即无需查询被驱动表</li>
<li>sing intersect(key…)：intersect索引合并</li>
<li>Using union(key…)：union索引合并</li>
<li>Using sort_union(key…)：sort_union索引合并</li>
<li>Zero limit:limit参数为0</li>
<li>Using filesort：无法使用索引排序，使用普通字段进行排序，一般是在内存或者磁盘中进行</li>
<li>Using temporary：无法使用索引进行去重或者排序等操作，会建立临时表查询</li>
<li>Start temporary, End temporary: IN子查询优化时使用DuplicateWeedout策略</li>
<li>LooseScan：IN子查询时使用LooseScan策略</li>
<li>FirstMatch：IN子查询转换为半连接时使用FirstMatch策略</li>
</ol>
<p>结语：EXPLAIN FORMAT=JSON 可以将执行结果json化</p>
<h2 id="内部优化过程（optimizer-trace）"><a href="#内部优化过程（optimizer-trace）" class="headerlink" title="内部优化过程（optimizer trace）"></a>内部优化过程（optimizer trace）</h2><p>追踪优化日志方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 1. 打开optimizer trace功能 (默认情况下它是关闭的):</span><br><span class="line">SET optimizer_trace&#x3D;&quot;enabled&#x3D;on&quot;;</span><br><span class="line"></span><br><span class="line"># 2. 查询语句,这里可以有多个查询语句</span><br><span class="line">SELECT ...; </span><br><span class="line"></span><br><span class="line"># 3. 查看上一个查询的优化过程，每条查询语句对应一个优化过程，也就是每写一个sql要查一次</span><br><span class="line">SELECT * FROM information_schema.OPTIMIZER_TRACE;</span><br><span class="line"></span><br><span class="line"># 5. 当你停止查看语句的优化过程时，把optimizer trace功能关闭</span><br><span class="line">SET optimizer_trace&#x3D;&quot;enabled&#x3D;off&quot;; </span><br></pre></td></tr></table></figure>
<h2 id="数据统计"><a href="#数据统计" class="headerlink" title="数据统计"></a>数据统计</h2><table>
<thead>
<tr>
<th>统计方式</th>
<th>描述</th>
<th>控制变量</th>
<th>值1</th>
<th>控制变量2</th>
<th>值2</th>
</tr>
</thead>
<tbody><tr>
<td>永久统计</td>
<td>统计数据持久化在磁盘</td>
<td>innodb_stats_persistent</td>
<td>on(mysql5.6.6之后默认)</td>
<td>STATS_PERSISTENT(该变量支持表级控制，即创建表的时候就可指定)</td>
<td>1</td>
</tr>
<tr>
<td>非永久统计</td>
<td>统计数在内存中</td>
<td>innodb_stats_persistent</td>
<td>off</td>
<td>STATS_PERSISTENT</td>
<td>1</td>
</tr>
</tbody></table>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">jiabin.wang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://dogyin.wang/2020/04/08/20200408-mysql04/">http://dogyin.wang/2020/04/08/20200408-mysql04/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://dogyin.wang" target="_blank">寅狗子</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/15/20200415-mysql05/"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">innodb缓存池</div></div></a></div><div class="next-post pull-right"><a href="/2020/04/04/20200404-mysql03/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">mysql表空间</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/03/27/20200327-mysql01/" title="mysql基础和INNODB引擎结构"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-27</div><div class="title">mysql基础和INNODB引擎结构</div></div></a></div><div><a href="/2020/04/04/20200404-mysql03/" title="mysql表空间"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-04</div><div class="title">mysql表空间</div></div></a></div><div><a href="/2020/04/01/20200401-mysql02/" title="mysql中的索引"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-01</div><div class="title">mysql中的索引</div></div></a></div><div><a href="/2020/04/15/20200415-mysql05/" title="innodb缓存池"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-15</div><div class="title">innodb缓存池</div></div></a></div><div><a href="/2020/04/25/20200421-mysql07/" title="mysql事务"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-25</div><div class="title">mysql事务</div></div></a></div><div><a href="/2020/04/20/20200420-mysql06/" title="mysql中的日志"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-20</div><div class="title">mysql中的日志</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">jiabin.wang</div><div class="author-info__description">大米和你缺一不可</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dogYin"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dogYin" target="_blank" title=""><i class="fa fa-github"></i></a><a class="social-icon" href="mailto:jiabinwang1010@126.com" target="_blank" title=""><i class="fa fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎指教</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">连接查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">连接分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%961"><span class="toc-number">1.2.</span> <span class="toc-text">优化1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.1.</span> <span class="toc-text">使用索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%9D%97%E7%9A%84%E5%B5%8C%E5%A5%97%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.2.2.</span> <span class="toc-text">基于块的嵌套连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%962%EF%BC%88%E5%9F%BA%E4%BA%8E%E6%88%90%E6%9C%AC%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">优化2（基于成本的优化）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%963%EF%BC%88%E5%9F%BA%E4%BA%8E%E8%A7%84%E5%88%99%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">优化3（基于规则的优化）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#explain%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.5.</span> <span class="toc-text">explain关键字详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%EF%BC%88optimizer-trace%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">内部优化过程（optimizer trace）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.7.</span> <span class="toc-text">数据统计</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/04/06/20210406-test/" title="测试mac中安装hexo"><img data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/xiong.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="测试mac中安装hexo"/></a><div class="content"><a class="title" href="/2021/04/06/20210406-test/" title="测试mac中安装hexo">测试mac中安装hexo</a><time datetime="2021-04-06T08:01:56.000Z" title="发表于 2021-04-06 16:01:56">2021-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/03/10/20210310-systemdesign01/" title="分布式ID和编号该怎么做？"><img data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/xiong.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式ID和编号该怎么做？"/></a><div class="content"><a class="title" href="/2021/03/10/20210310-systemdesign01/" title="分布式ID和编号该怎么做？">分布式ID和编号该怎么做？</a><time datetime="2021-03-10T13:50:27.000Z" title="发表于 2021-03-10 21:50:27">2021-03-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/05/20210205-mysql-advance/" title="mysql主从复制方案"><img data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql主从复制方案"/></a><div class="content"><a class="title" href="/2021/02/05/20210205-mysql-advance/" title="mysql主从复制方案">mysql主从复制方案</a><time datetime="2021-02-05T09:44:11.000Z" title="发表于 2021-02-05 17:44:11">2021-02-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/30/20201230-jvm02/" title="垃圾回收随笔"><img data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/java.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="垃圾回收随笔"/></a><div class="content"><a class="title" href="/2020/12/30/20201230-jvm02/" title="垃圾回收随笔">垃圾回收随笔</a><time datetime="2020-12-30T08:12:09.000Z" title="发表于 2020-12-30 16:12:09">2020-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/25/20201225-io/" title="Reactor模型出现的原因"><img data-lazy-src="https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/tcp_bg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Reactor模型出现的原因"/></a><div class="content"><a class="title" href="/2020/12/25/20201225-io/" title="Reactor模型出现的原因">Reactor模型出现的原因</a><time datetime="2020-12-25T06:09:29.000Z" title="发表于 2020-12-25 14:09:29">2020-12-25</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/dogYin/imgOSS/img/mysqllogo.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By jiabin.wang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi,Welcome to my <a href="https://dogyin.wang/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'rjLDfYWwpeh7n3l46Fx64V39-9Nh9j0Va',
      appKey: 'lWS3xE4gbPNjClMV5DoTXbVV',
      placeholder: '若文章有误，麻烦大佬指教！！！',
      avatar: 'monsterid',
      meta: '昵称,联系方式,网站链接'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('昵称,联系方式'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script></div></body></html>